YUI.add("moodle-atto_youtube-button",function(e,t){var n={INPUTEND:"atto_youtube_endentry",INPUTSUBMIT:"atto_youtube_urlentrysubmit",INPUTURL:"atto_youtube_urlentry",INPUTTIME:"atto_youtube_time",INPUTSTART:"atto_youtube_startentry",YOUTUBEPREVIEW:"atto_youtube_preview",YOUTUBEPREVIEWBOX:"atto_youtube_preview_box"},r={INPUTURL:"."+n.INPUTURL},i="atto_youtube",s='<form class="atto_form"><label for="{{elementid}}_{{CSS.INPUTURL}}">{{get_string "enterurl" component}}</label><input class="fullwidth {{CSS.INPUTURL}}" type="url" id="{{elementid}}_{{CSS.INPUTURL}}" size="32"/><br/><div id="{{elementid}}_{{CSS.INPUTTIME}}" class="{{CSS.INPUTTIME}}"><label for="{{elementid}}_{{CSS.INPUTSTART}}">Start Time (mm:ss)</label><input type="text" class="{{CSS.INPUTSTART}} input-mini" id="{{elementid}}_{{CSS.INPUTSTART}}" size="4"/><br/><label for="{{elementid}}_{{CSS.INPUTEND}}">End Time (mm:ss)</label><input type="text" class="{{CSS.INPUTEND}} input-mini" id="{{elementid}}_{{CSS.INPUTEND}}" size="4"/></div><div class="mdl-align"><div class="{{CSS.YOUTUBEPREVIEWBOX}}"><iframe src="#" class="{{CSS.YOUTUBEPREVIEW}}" frameborder="0" style="display: none;"></iframe></div><button class="{{CSS.INPUTSUBMIT}}" type="submit">{{get_string "createvideo" component}}</button></div></form>',o='<span class="mediaplugin mediaplugin_youtube"><iframe src="{{url}}?start={{start}}{{{amp}}}end={{end}}{{{amp}}}modestbranding=1{{{amp}}}rel=0{{{amp}}}showinfo=0" width="400" height="300" allowfullscreen="1" class="youtuberestrict"></iframe></span>';e.namespace("M.atto_youtube").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{_currentSelection:null,_selectedvideo:null,_form:null,_rawVideoProperties:null,initializer:function(){this.addButton({icon:"e/insert_time",callback:this._displayDialogue}),this.editor.delegate("dblclick",this._displayDialogue,"iframe",this),this.editor.delegate("click",this._handleClick,"iframe",this)},_handleClick:function(e){var t=e.target,n=this.get("host").getSelectionFromNode(t);this.get("host").getSelection()!==n&&this.get("host").setSelection(n)},_displayDialogue:function(){this._currentSelection=this.get("host").getSelection();if(this._currentSelection===!1)return;this._rawVideoProperties=null;var e=this.getDialogue({headerContent:M.util.get_string("cropvideo",i),width:"480px",focusAfterHide:!0,focusOnShowSelector:r.INPUTURL});e.set("bodyContent",this._getDialogueContent()).show()},_loadPreviewVideo:function(e){var t,r,i,s;this._rawVideoProperties=this._parseTimes(e),t=this._form.one("."+n.INPUTSTART),r=t.get("value"),r===""?(t.set("value",this._secondsToHMS(this._rawVideoProperties.start)),r=this._rawVideoProperties.start):r=this._HMSToseconds(r),t=this._form.one("."+n.INPUTEND),i=t.get("value"),i===""?(t.set("value",this._secondsToHMS(this._rawVideoProperties.end)),i=this._rawVideoProperties.end):i=this._HMSToseconds(i),t=this._form.one("."+n.YOUTUBEPREVIEW),s=this._rawVideoProperties.src+"?modestbranding=1&rel=0&showinfo=0&start="+r+"&end="+i,t.src!==s&&(t.setAttribute("src",s),t.setStyles({display:"inline"}),this.getDialogue().centerDialogue())},_getDialogueContent:function(){var t=e.Handlebars.compile(s),r=e.Node.create(t({elementid:this.get("host").get("elementid"),CSS:n,component:i}));return this._form=r,this._applyVideoProperties(this._form),this._form.one("."+n.INPUTURL).on("blur",this._urlChanged,this),this._form.one("."+n.INPUTSTART).on("blur",this._urlChanged,this),this._form.one("."+n.INPUTEND).on("blur",this._urlChanged,this,!0),this._form.one("."+n.INPUTSUBMIT).on("click",this._setImage,this),r},_applyVideoProperties:function(e){var t=this._getSelectedVideoProperties(),r=e.one("."+n.YOUTUBEPREVIEW);if(t===!1){r.setStyle("display","none");return}t.start&&e.one("."+n.INPUTSTART).set("value",this._secondsToHMS(t.start)),t.end&&e.one("."+n.INPUTEND).set("value",this._secondsToHMS(t.end)),t.src&&(e.one("."+n.INPUTURL).set("value",t.src),this._loadPreviewVideo(t.src))},_getSelectedVideoProperties:function(){var e=this.get("host").getSelectedNodes(),t;return e&&(e=e.filter(".youtuberestrict")),e&&e.size()?(t=e.item(0).getAttribute("src"),this._parseTimes(t)):(this._selectedvideo=null,!1)},_parseTimes:function(e){var t={start:null,end:null,src:null},n,r;e.indexOf("youtube.com/embed/")!==-1&&(t.src=e.split("?")[0]);if(e.indexOf("?")===-1)return t;n=e.split("?")[1].split("&");for(r=0;r<n.length;r++)n[r].indexOf("start")===0&&(t.start=n[r].split("=")[1]),n[r].indexOf("end")===0&&(t.end=n[r].split("=")[1]),n[r].indexOf("v")===0&&(t.src="https://www.youtube.com/embed/"+n[r].split("=")[1]);return t},_urlChanged:function(){var e=this._form.one("."+n.INPUTURL);e.get("value")!==""&&this._loadPreviewVideo(e.get("value"))},_setImage:function(t){var r=this._form,i=r.one("."+n.INPUTURL).get("value"),s=this._HMSToseconds(r.one("."+n.INPUTSTART).get("value")),u=this._HMSToseconds(r.one("."+n.INPUTEND).get("value")),a,f,l=this.get("host");t.preventDefault(),l.focus(),i!==""&&(this._selectedvideo?l.setSelection(l.getSelectionFromNode(this._selectedvideo)):l.setSelection(this._currentSelection),i=this._parseTimes(i).src,f=e.Handlebars.compile(o),a=f({url:i,start:s,end:u,amp:"&"}),this.get("host").insertContentAtFocusPoint(a),this.markUpdated()),this.getDialogue({focusAfterHide:null}).hide()},_secondsToHMS:function(e){var t=Math.floor(e/60);return e-=t*60,t<10&&(t="0"+t),e=Math.floor(e),e<10&&(e="0"+e),t+":"+e},_HMSToseconds:function(e){var t=/(\d+?):(\d\d)/.exec(e),n=parseInt(t[1],10),r=parseInt(t[2],10);return n*60+r}})},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
